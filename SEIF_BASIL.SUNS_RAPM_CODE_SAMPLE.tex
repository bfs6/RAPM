\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Updated RAPM Model Documentation},
            pdfauthor={Basil Seif},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Updated RAPM Model Documentation}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Basil Seif}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{8/14/2019}


\begin{document}
\maketitle

\section{Introduction}

This version of regularized-adjusted plus-minus (RAPM) draws on a number
of previously done RAPM calculations and open source studies on player
evaulation, including work done by Joe Sill, Jeremias Engelman, and
Justin Jacobs. The general goal of RAPM is to measure on-court player
performance while minimizing the effect that different players and
lineups have on that individual performance. The way RAPM does this is
by using ridge regression to tease out a player's on-court contribution
while minimizing multicollinearity between different players.

Older versions of RAPM mainly focus on creating one holistic measurement
based on the points margin of each 10-player stint (a stint is defined
as a group of 10 players that are on the floor at any given time). In
this version of RAPM, I will be calculating Offensive and Defensive RAPM
and adding them together for each player to get a total RAPM value. This
specific version of RAPM will be a 1 year RAPM model for each player
from 1998-present including all Regular Season and Playoff games that
each player played in a given season.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{####Read in Libraries####}
\KeywordTok{library}\NormalTok{(RODBC)}
\KeywordTok{library}\NormalTok{(data.table)}
\KeywordTok{library}\NormalTok{(RColorBrewer)}
\KeywordTok{library}\NormalTok{(weights)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(Hmisc)}
\KeywordTok{library}\NormalTok{(glmnet)}
\KeywordTok{library}\NormalTok{(tidyr)}
\KeywordTok{library}\NormalTok{(SafeBayes)}
\KeywordTok{library}\NormalTok{(matlib)}
\KeywordTok{library}\NormalTok{(plyr)}
\KeywordTok{library}\NormalTok{(Matrix)}

\NormalTok{####Helper Functions####}
\NormalTok{remove_zero_var_cols <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{  colsToRemove <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(df))\{}
    \ControlFlowTok{if}\NormalTok{(}\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(df[,i])) }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{)\{}
\NormalTok{      colsToRemove <-}\StringTok{ }\KeywordTok{c}\NormalTok{(i, colsToRemove)}
\NormalTok{    \}}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{(}\KeywordTok{length}\NormalTok{(colsToRemove) }\OperatorTok{>=}\StringTok{ }\DecValTok{1}\NormalTok{)\{}
\NormalTok{    df <-}\StringTok{ }\NormalTok{df[,}\OperatorTok{-}\NormalTok{colsToRemove]}
\NormalTok{  \}}
  \KeywordTok{return}\NormalTok{(df)}
\NormalTok{\}}
\NormalTok{outersect <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x, y) \{}
  \KeywordTok{sort}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\KeywordTok{setdiff}\NormalTok{(x, y),}
         \KeywordTok{setdiff}\NormalTok{(y, x)))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\section{Getting and Cleaning the Data}

The first obvious step in building this model is to pull in the correct
data from the database. As it currently stands, our database extracts
NBA lineup data and calculates box score stats, starting scores, ending
scores, and lineups for each stint in each NBA game (playoffs and
regular season) starting as early as the 1997-18 NBA season. The below
code pulls all of these stints from 1998-present and saves them in the
\(nba\_lineup\_game\_dim\) dataframe. I also decided to pull from the
\(nba\_all\_player\_stats\) table and \(apm\_player\_stats\) table for
future use in this analysis.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{####Read in Data####}
\NormalTok{mydb <-}\StringTok{ }\KeywordTok{odbcDriverConnect}\NormalTok{(}\DataTypeTok{connection =} \StringTok{"Driver=\{SQL Server Native Client 11.0\};server=PHX-SQL07}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{BBOPS; database=BOps_DW;trusted_connection=yes;"}\NormalTok{)}
\NormalTok{nba_lineup_game_dim <-}\StringTok{ }\KeywordTok{sqlQuery}\NormalTok{(mydb, }\StringTok{"select * from dbo.nba_lineup_game_dim}
\StringTok{                                            where 1 = 1}
\StringTok{                                            and league_id = 00}
\StringTok{                                            and season_type in ('Regular Season', 'Playoffs')"}\NormalTok{)}
\NormalTok{nba_all_player_stats <-}\StringTok{ }\KeywordTok{sqlQuery}\NormalTok{(mydb, }\StringTok{"select * from dbo.nba_all_player_stats}
\StringTok{                                            where 1 = 1}
\StringTok{                                            and league_id = 00}
\StringTok{                                            and season_type = 'Regular Season'}
\StringTok{                                                                and game_id = 'All'}
\StringTok{                                                                and stat_type = 'Totals'}
\StringTok{                                          and team_id <> 'TOT'"}\NormalTok{)}
\NormalTok{apm_player_stats <-}\StringTok{ }\KeywordTok{sqlQuery}\NormalTok{(mydb, }\StringTok{"select * from dbo.apm_player_stats}
\StringTok{                                          where 1 = 1}
\StringTok{                                          and league_id = 00}
\StringTok{                                          and game_id = 'All'}
\StringTok{                                          and stat_type = 'Totals'"}\NormalTok{)}
\KeywordTok{odbcClose}\NormalTok{(mydb)}


\NormalTok{####Clean Data####}
\NormalTok{nba_lineup_game_dim}\OperatorTok{$}\NormalTok{season_num <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{gsub}\NormalTok{(}\StringTok{"NBA_"}\NormalTok{, }\StringTok{""}\NormalTok{, nba_lineup_game_dim}\OperatorTok{$}\NormalTok{season_name))}
\NormalTok{nba_lineup_game_dim <-}\StringTok{ }\KeywordTok{remove_zero_var_cols}\NormalTok{(nba_lineup_game_dim)}
\NormalTok{nba_all_player_stats <-}\StringTok{ }\KeywordTok{remove_zero_var_cols}\NormalTok{(nba_all_player_stats)}
\NormalTok{nba_all_player_stats_totals <-}\StringTok{ }\KeywordTok{setDT}\NormalTok{(nba_all_player_stats)[, }\KeywordTok{lapply}\NormalTok{(.SD, sum), by =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"person_id"}\NormalTok{, }\StringTok{"season_name"}\NormalTok{), .SDcols =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{names}\NormalTok{(nba_all_player_stats)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"poss_"}\NormalTok{, }\KeywordTok{names}\NormalTok{(nba_all_player_stats)) }\OperatorTok{==}\StringTok{ }\NormalTok{T)], }\StringTok{"mp"}\NormalTok{)]}
\NormalTok{apm_player_stats <-}\StringTok{ }\KeywordTok{remove_zero_var_cols}\NormalTok{(apm_player_stats)}
\end{Highlighting}
\end{Shaded}

\section{Creating the Stint Matrix}

Building the stint matrix is one of the keys of developing a RAPM model.
If there are \(p\) players in the NBA and \(s\) stints in a given
timeframe, the basic stint matrix should be a \(s\) x \(2p + 1\) matrix
with an offensive and defensive column for each player populated with
1's if a player played on offense in a specific stint, -1's if a player
played on defense in a specific stint, and 0's otherwise. The extra
column is a constant column populated with 1's and
\(100 * points scored per offensive possession\) is the target vector.

\subsection{Cleaning Stint Data before Building Stint Matrix}

The first step in building the stint matrix for a given year is to
filter and clean the data properly. In this fist section of code, I
define the first and last years observed in the overall play by play
data as well as an empty list \(RAPM\_list\) to store the results for
each year. I have also coded an option to run a 2 or 3 year RAPM model.
If \(RAPM\_type\) is changed from 1 to 2 or 3, the stints used to model
RAPM will be stints played from the last 2 or 3 season of available NBA
play by play data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{####Stint Evaluation####}
\NormalTok{RAPM_type =}\StringTok{ }\DecValTok{1}
\NormalTok{RAPM_list <-}\StringTok{ }\KeywordTok{list}\NormalTok{()}
\NormalTok{seasons_loop_min =}\StringTok{ }\KeywordTok{min}\NormalTok{(nba_lineup_game_dim}\OperatorTok{$}\NormalTok{season_num) }\OperatorTok{-}\StringTok{ }\NormalTok{(RAPM_type }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{seasons_loop_max =}\StringTok{ }\KeywordTok{max}\NormalTok{(nba_lineup_game_dim}\OperatorTok{$}\NormalTok{season_num)}
\NormalTok{seasons_loop =}\StringTok{ }\KeywordTok{c}\NormalTok{(seasons_loop_min}\OperatorTok{:}\NormalTok{seasons_loop_max)}
\end{Highlighting}
\end{Shaded}

This is also where I start a for loop that cycles through each season or
timeframe and calculates RAPM for the corresponding players. The main
goal here is to set the appropriate date filters to the data and to get
rid of any garbage time stints that the data may have.

When filtering the data for each season, I take either the stint data
for the season indicated by \(ssn\) or the stint data for that season
and several previous seasons as well (depending on if we are doing a
1-year, 2-year, or 3-year RAPM). Another important thing to note is that
I take only the stints for the home team (each stint is listed in the
data twice, once for each team. While we are filtering out half of the
stints, in the end the final stint matrix will also have a duplicate of
each stint, in order to account for each team playing both offense and
defense in the same stint).

The next step is to arrange the data by \(game\_id\), \(period\), and
\(game\_clock\). Here, I also address the issue of stints with 0
possessions that have more than 0 points scored. Depending on how points
are counted, this may be the case if a lineup is specifically subbed in
for a free throw. For stints like this, I change the number of
possessions to 1. I filter out any other stints where there are 0
possessions and zero points. Fixing these issues is important when
calculating the target vector later in the modeling (Note: these stints
with 0 possessions and more than 0 points can be entirely excluded from
the dataset, it is really up to how you want to interpret the data).

The next important step in this part of the code is to get rid of any
garbage time stints that may bias the results. To define garbage time, I
used Ben Falk's garbage time rules that he uses to calculate many of the
metrics from his website CleaningTheGlass.com. To summarize them, there
are 3 specific ways that garbage time can be defined: 1) if there are
9-12 minutes left in a game and the margin is greater than or equal to
25 points, 2) if there are 6-9 minutes left in a game and the margin is
greater than or equal to 20 points, and 3) if there are \textless{}= 6
minutes left in a game and the margin is greater than or equal to 10
points. If the margin dips below any of these benchmarks during any of
these specificed time markers, those stints are not considered garbage
time.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{####Start Stint Evaluation For Loop####}
\ControlFlowTok{for}\NormalTok{(ssn }\ControlFlowTok{in}\NormalTok{ seasons_loop)\{}
  \CommentTok{#print(ssn)}
\NormalTok{  ##Filter Down Data for Each Year}
  \ControlFlowTok{if}\NormalTok{(RAPM_type }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{)\{}
\NormalTok{    dataRAPM <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(nba_lineup_game_dim, season_num }\OperatorTok{==}\StringTok{ }\NormalTok{ssn }\OperatorTok{&}\StringTok{ }\NormalTok{home_away }\OperatorTok{==}\StringTok{ "Home"}\NormalTok{)}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    dataRAPM <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(nba_lineup_game_dim, season_num }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{((ssn }\OperatorTok{-}\StringTok{ }\NormalTok{(RAPM_type }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{))}\OperatorTok{:}\NormalTok{ssn) }\OperatorTok{&}\StringTok{ }\NormalTok{home_away }\OperatorTok{==}\StringTok{ "Home"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  dataRAPM <-}\StringTok{ }\KeywordTok{arrange}\NormalTok{(dataRAPM, game_id, period, }\OperatorTok{-}\NormalTok{game_clock_int_start)}
\NormalTok{  dataRAPM}\OperatorTok{$}\NormalTok{poss_tot[}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{pts }\OperatorTok{>}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{poss_tot }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)] =}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{pts }\OperatorTok{>}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{poss_tot }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)))}
\NormalTok{  dataRAPM}\OperatorTok{$}\NormalTok{poss_tot[}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_pts }\OperatorTok{>}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{poss_tot }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)] =}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\KeywordTok{length}\NormalTok{(}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_pts }\OperatorTok{>}\StringTok{ }\DecValTok{0} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{poss_tot }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)))}
  \CommentTok{#dataRAPM <- filter(dataRAPM, poss_tot > 0 & poss_off > 0 & poss_def > 0)}
\NormalTok{  dataRAPM <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(dataRAPM, poss_tot }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{)}
  
\NormalTok{  ##Filter Out Garbage Time Stints}
  \CommentTok{#First Garbage Time Rule}
\NormalTok{  garbage_time_ind1_games <-}\StringTok{ }\NormalTok{dataRAPM }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(game_id) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(period }\OperatorTok{==}\StringTok{ }\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{game_clock_int_start }\OperatorTok{<=}\StringTok{ }\DecValTok{72000} \OperatorTok{&}\StringTok{ }\NormalTok{game_clock_int_start }\OperatorTok{>}\StringTok{ }\DecValTok{54000}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{score_end =}\NormalTok{ (opp_score_end }\OperatorTok{-}\StringTok{ }\NormalTok{score_end), }\DataTypeTok{score_start =}\NormalTok{ (opp_score_start }\OperatorTok{-}\StringTok{ }\NormalTok{score_start)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(game_id, score_end, score_start)}
\NormalTok{  garbage_time_ind1_games <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(garbage_time_ind1_games[}\KeywordTok{c}\NormalTok{(}\KeywordTok{which}\NormalTok{(garbage_time_ind1_games}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{>=}\StringTok{ }\DecValTok{25} \OperatorTok{&}\StringTok{ }\NormalTok{garbage_time_ind1_games}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{<=}\StringTok{ }\DecValTok{25}\NormalTok{), }\KeywordTok{which}\NormalTok{(garbage_time_ind1_games}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{<=}\StringTok{ }\OperatorTok{-}\DecValTok{25} \OperatorTok{&}\StringTok{ }\NormalTok{garbage_time_ind1_games}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{>=}\StringTok{ }\OperatorTok{-}\DecValTok{25}\NormalTok{)), }\StringTok{"game_id"}\NormalTok{])}
\NormalTok{  garbage_time_ind1 <-}\StringTok{ }\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{period }\OperatorTok{==}\StringTok{ }\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_start }\OperatorTok{<=}\StringTok{ }\DecValTok{72000} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_start }\OperatorTok{>}\StringTok{ }\DecValTok{54000} \OperatorTok{&}\StringTok{ }
\StringTok{                               }\KeywordTok{abs}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_score_end }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_end) }\OperatorTok{>=}\StringTok{ }\DecValTok{25} \OperatorTok{&}\StringTok{ }\KeywordTok{abs}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_score_start }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_start) }\OperatorTok{>=}\StringTok{ }\DecValTok{25}\NormalTok{)}
  
  \CommentTok{#Second Garbage Time Rule}
\NormalTok{  garbage_time_ind2_games <-}\StringTok{ }\NormalTok{dataRAPM }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(game_id) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(period }\OperatorTok{==}\StringTok{ }\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{game_clock_int_start }\OperatorTok{<=}\StringTok{ }\DecValTok{54000} \OperatorTok{&}\StringTok{ }\NormalTok{game_clock_int_start }\OperatorTok{>}\StringTok{ }\DecValTok{36000}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{score_end =}\NormalTok{ (opp_score_end }\OperatorTok{-}\StringTok{ }\NormalTok{score_end), }\DataTypeTok{score_start =}\NormalTok{ (opp_score_start }\OperatorTok{-}\StringTok{ }\NormalTok{score_start)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(game_id, score_end, score_start)}
\NormalTok{  garbage_time_ind2_games <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(garbage_time_ind2_games[}\KeywordTok{c}\NormalTok{(}\KeywordTok{which}\NormalTok{(garbage_time_ind2_games}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{>=}\StringTok{ }\DecValTok{20} \OperatorTok{&}\StringTok{ }\NormalTok{garbage_time_ind2_games}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{<=}\StringTok{ }\DecValTok{20}\NormalTok{), }\KeywordTok{which}\NormalTok{(garbage_time_ind2_games}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{<=}\StringTok{ }\OperatorTok{-}\DecValTok{20} \OperatorTok{&}\StringTok{ }\NormalTok{garbage_time_ind2_games}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{>=}\StringTok{ }\OperatorTok{-}\DecValTok{20}\NormalTok{)), }\StringTok{"game_id"}\NormalTok{])}
\NormalTok{  garbage_time_ind2 <-}\StringTok{ }\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{period }\OperatorTok{==}\StringTok{ }\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_start }\OperatorTok{<=}\StringTok{ }\DecValTok{54000} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_start }\OperatorTok{>}\StringTok{ }\DecValTok{36000} \OperatorTok{&}\StringTok{ }
\StringTok{                               }\KeywordTok{abs}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_score_end }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_end) }\OperatorTok{>=}\StringTok{ }\DecValTok{20} \OperatorTok{&}\StringTok{ }\KeywordTok{abs}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_score_start }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_start) }\OperatorTok{>=}\StringTok{ }\DecValTok{20}\NormalTok{) }
  
  \CommentTok{#Third Garbage Time Rule}
\NormalTok{  garbage_time_ind3_games <-}\StringTok{ }\NormalTok{dataRAPM }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(game_id) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(period }\OperatorTok{==}\StringTok{ }\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{game_clock_int_start }\OperatorTok{<=}\StringTok{ }\DecValTok{36000}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{score_end =}\NormalTok{ (opp_score_end }\OperatorTok{-}\StringTok{ }\NormalTok{score_end), }\DataTypeTok{score_start =}\NormalTok{ (opp_score_start }\OperatorTok{-}\StringTok{ }\NormalTok{score_start)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(game_id, score_end, score_start)}
\NormalTok{  garbage_time_ind3_games <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(garbage_time_ind3_games[}\KeywordTok{c}\NormalTok{(}\KeywordTok{which}\NormalTok{(garbage_time_ind3_games}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{>=}\StringTok{ }\DecValTok{10} \OperatorTok{&}\StringTok{ }\NormalTok{garbage_time_ind3_games}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{<=}\StringTok{ }\DecValTok{10}\NormalTok{), }\KeywordTok{which}\NormalTok{(garbage_time_ind3_games}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{<=}\StringTok{ }\OperatorTok{-}\DecValTok{10} \OperatorTok{&}\StringTok{ }\NormalTok{garbage_time_ind3_games}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{>=}\StringTok{ }\OperatorTok{-}\DecValTok{10}\NormalTok{)), }\StringTok{"game_id"}\NormalTok{])}
\NormalTok{  garbage_time_ind3 <-}\StringTok{ }\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{period }\OperatorTok{==}\StringTok{ }\DecValTok{4} \OperatorTok{&}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_start }\OperatorTok{<=}\StringTok{ }\DecValTok{36000} \OperatorTok{&}\StringTok{ }
\StringTok{                               }\KeywordTok{abs}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_score_end }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_end) }\OperatorTok{>=}\StringTok{ }\DecValTok{10} \OperatorTok{&}\StringTok{ }\KeywordTok{abs}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_score_start }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_start) }\OperatorTok{>=}\StringTok{ }\DecValTok{10}\NormalTok{) }
  
  \CommentTok{#Combine and Filter}
\NormalTok{  garbage_time_games_exclude <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(}\KeywordTok{c}\NormalTok{(garbage_time_ind1_games}\OperatorTok{$}\NormalTok{game_id, garbage_time_ind2_games}\OperatorTok{$}\NormalTok{game_id, garbage_time_ind3_games}\OperatorTok{$}\NormalTok{game_id))}
\NormalTok{  garbage_time_games_exclude_ind <-}\StringTok{ }\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{game_id }\OperatorTok{%in%}\StringTok{ }\NormalTok{garbage_time_games_exclude)}
\NormalTok{  garbage_time_ind <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(}\KeywordTok{c}\NormalTok{(garbage_time_ind1, garbage_time_ind2, garbage_time_ind3))}
\NormalTok{  garbage_time_ind <-}\StringTok{ }\NormalTok{garbage_time_ind[}\OperatorTok{-}\KeywordTok{which}\NormalTok{(garbage_time_ind }\OperatorTok{%in%}\StringTok{ }\NormalTok{garbage_time_games_exclude_ind)]}
\NormalTok{  dataRAPM <-}\StringTok{ }\NormalTok{dataRAPM[}\OperatorTok{-}\NormalTok{garbage_time_ind, ]}
\NormalTok{  dataRAPM <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(dataRAPM, }\KeywordTok{is.na}\NormalTok{(score_start) }\OperatorTok{==}\StringTok{ }\NormalTok{F)}
\NormalTok{  dataRAPMPossOffInd <-}\StringTok{ }\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{poss_off }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)}
\NormalTok{  dataRAPMPossDefInd <-}\StringTok{ }\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{poss_def }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{)}
  
\NormalTok{  ##Find All Unique Player IDs}
\NormalTok{  player_id_refs <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{person_id =} \KeywordTok{as.vector}\NormalTok{(}\KeywordTok{t}\NormalTok{(dataRAPM[,}\KeywordTok{names}\NormalTok{(dataRAPM)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"_person_id"}\NormalTok{,}\KeywordTok{names}\NormalTok{(dataRAPM)))]])),}
                               \DataTypeTok{full_name =} \KeywordTok{as.vector}\NormalTok{(}\KeywordTok{t}\NormalTok{(dataRAPM[,}\KeywordTok{names}\NormalTok{(dataRAPM)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"team_player.*_full_name"}\NormalTok{, }\KeywordTok{names}\NormalTok{(dataRAPM)))]])))}
\NormalTok{  player_id_refs <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(player_id_refs)}
  \KeywordTok{row.names}\NormalTok{(player_id_refs) =}\StringTok{ }\OtherTok{NULL}
\NormalTok{  unique_ID =}\StringTok{ }\KeywordTok{unique}\NormalTok{(player_id_refs}\OperatorTok{$}\NormalTok{person_id)}
\NormalTok{  keep_id_unique =}\StringTok{ }\KeywordTok{match}\NormalTok{(unique_ID, player_id_refs}\OperatorTok{$}\NormalTok{person_id)}
\NormalTok{  player_id_refs =}\StringTok{ }\NormalTok{player_id_refs[keep_id_unique,]}
\NormalTok{  player_id_refs =}\StringTok{ }\KeywordTok{arrange}\NormalTok{(player_id_refs, person_id)}
  
\NormalTok{  ##Find Low Min Players}
\NormalTok{  playerTotals <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(nba_all_player_stats_totals, season_name }\OperatorTok{==}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"NBA_"}\NormalTok{, ssn))}
  \CommentTok{# minCutoff <- 250}
  \CommentTok{# HighMinPlayerTotals <- filter(playerTotals, mp >= minCutoff)}
  \CommentTok{# LowMinPlayerTotals <- filter(playerTotals, mp < minCutoff)}
  
\NormalTok{  ##Filter Out All Star Stuff}
\NormalTok{  team_ref_ids <-}\StringTok{ }\KeywordTok{unique}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\StringTok{"team_abbr"}\NormalTok{, }\StringTok{"home_team_id"}\NormalTok{)])}
\NormalTok{  team_ref_ids <-}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(team_ref_ids[}\DecValTok{1}\OperatorTok{:}\DecValTok{30}\NormalTok{,])}
  \KeywordTok{row.names}\NormalTok{(team_ref_ids) <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  team_ref_ids <-}\StringTok{ }\KeywordTok{arrange}\NormalTok{(team_ref_ids, home_team_id)}
\NormalTok{  dataRAPM <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(dataRAPM, home_team_id }\OperatorTok{%in%}\StringTok{ }\NormalTok{team_ref_ids}\OperatorTok{$}\NormalTok{home_team_id)}
\NormalTok{  team_ref_ids <-}\StringTok{ }\KeywordTok{setDT}\NormalTok{(team_ref_ids)[, .SD[}\DecValTok{1}\NormalTok{], by =}\StringTok{ "home_team_id"}\NormalTok{]}
\NormalTok{  team_ref_ids <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(team_ref_ids)}
\end{Highlighting}
\end{Shaded}

\subsection{Feature Engineering}

In most RAPM models, the stint matrix and the target are the only things
needed. However, because we have the data easily accessible, I have
added features to reflect the effects of home court advantage, days
rest, the score difference at a certain point of the game, and time
remaining in a game.

For the home court features, I created a binary matrix with the home
team in each stint indicated as a 1 and the away team in each stint
indicated with a -1.

For the days rest feature, I created a similar binary matrix with
columns for the number of days of rest for a team and the number of days
of rest for an opposing team. All of the columns corresponding to the
days rest of the opposing team are filled with -1's instead of 1's. Days
rest in a given NBA season can range from 0 to 3 days for the bulk of
the schedule, up to 7 to 10 days for unique parts of the schedule (All
Star Break).

For the score difference feature, I calculate every 5th percentile of
scoring differences throughout the stint data and create a binary matrix
to indicate whether or not a score margin for a certain stint falls into
one of those ranges.

Finally, the time remaining feature is simply a vector of the average of
time remaining at the beginning of a stint and at the end of a stint.
This is then multiplied by the score difference matrix to create a
combined score difference/time remaining effect.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{  ##Add Home Court Features (Home Court, Days Rest, Score Diff, Time Remaining)}
\NormalTok{  homeCourtMat <-}\StringTok{ }\KeywordTok{model.matrix}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{as.character}\NormalTok{(home_team_id) }\OperatorTok{+}\StringTok{ }\DecValTok{0}\NormalTok{, dataRAPM)}
  \KeywordTok{colnames}\NormalTok{(homeCourtMat) <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"HomeCourt_"}\NormalTok{, team_ref_ids}\OperatorTok{$}\NormalTok{team_abbr)}
\NormalTok{  homeCourtMat2 <-}\StringTok{ }\NormalTok{homeCourtMat }\OperatorTok{*}\StringTok{ }\OperatorTok{-}\DecValTok{1}
\NormalTok{  homeCourtMatFull <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(homeCourtMat, homeCourtMat2)}
  
\NormalTok{  ##Add Days Rest Features}
\NormalTok{  dataRAPM}\OperatorTok{$}\NormalTok{team_days_rest[}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{team_days_rest }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{)] =}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{length}\NormalTok{(}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{team_days_rest }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{)))}
\NormalTok{  dataRAPM}\OperatorTok{$}\NormalTok{opp_team_days_rest[}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_team_days_rest }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{)] =}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{length}\NormalTok{(}\KeywordTok{which}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_team_days_rest }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{)))}
\NormalTok{  daysRestMat <-}\StringTok{ }\KeywordTok{model.matrix}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{as.character}\NormalTok{(team_days_rest) }\OperatorTok{+}\StringTok{ }\DecValTok{0}\NormalTok{, dataRAPM)}
\NormalTok{  oppDaysRestMat <-}\StringTok{ }\KeywordTok{model.matrix}\NormalTok{(}\OperatorTok{~}\StringTok{ }\KeywordTok{as.character}\NormalTok{(opp_team_days_rest) }\OperatorTok{+}\StringTok{ }\DecValTok{0}\NormalTok{, dataRAPM)}
\NormalTok{  oppDaysRestMat <-}\StringTok{ }\NormalTok{oppDaysRestMat }\OperatorTok{*}\StringTok{ }\OperatorTok{-}\DecValTok{1}
  \KeywordTok{colnames}\NormalTok{(daysRestMat) <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"as.character[(]team_days_rest[)]"}\NormalTok{, }\StringTok{"DaysRest"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(daysRestMat))}
  \KeywordTok{colnames}\NormalTok{(oppDaysRestMat) <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"as.character[(]opp_team_days_rest[)]"}\NormalTok{, }\StringTok{"OppDaysRest"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(oppDaysRestMat))}
\NormalTok{  daysRestMatFull <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(daysRestMat, oppDaysRestMat)}
  
\NormalTok{  daysRestMat2 <-}\StringTok{ }\NormalTok{oppDaysRestMat }\OperatorTok{*}\StringTok{ }\OperatorTok{-}\DecValTok{1}
\NormalTok{  oppDaysRestMat2 <-}\StringTok{ }\NormalTok{daysRestMat }\OperatorTok{*}\StringTok{ }\OperatorTok{-}\DecValTok{1}
  \KeywordTok{colnames}\NormalTok{(daysRestMat2) <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"OppDaysRest"}\NormalTok{, }\StringTok{"DaysRest"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(daysRestMat2))}
  \KeywordTok{colnames}\NormalTok{(oppDaysRestMat2) <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"DaysRest"}\NormalTok{, }\StringTok{"OppDaysRest"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(oppDaysRestMat2))}
\NormalTok{  daysRestMatFull2 <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(daysRestMat2, oppDaysRestMat2)}
  
\NormalTok{  daysRestMatFull <-}\StringTok{ }\KeywordTok{rbind.fill.matrix}\NormalTok{(daysRestMatFull, daysRestMatFull2)}
\NormalTok{  daysRestMatFull <-}\StringTok{ }\NormalTok{daysRestMatFull[,}\KeywordTok{sort}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(daysRestMatFull))]}
\NormalTok{  daysRestMatFull[}\KeywordTok{is.na}\NormalTok{(daysRestMatFull)] =}\StringTok{ }\DecValTok{0}
  
\NormalTok{  ##Score Difference Features}
\NormalTok{  scoreDiff <-}\StringTok{ }\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{score_start }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{opp_score_start }\OperatorTok{+}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{score_end }\OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{opp_score_end)}\OperatorTok{/}\DecValTok{2}
\NormalTok{  scoreDiff2 <-}\StringTok{ }\NormalTok{scoreDiff }\OperatorTok{*}\StringTok{ }\OperatorTok{-}\DecValTok{1}
\NormalTok{  scoreDiffBins <-}\StringTok{ }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{c}\NormalTok{(scoreDiff, scoreDiff2), }\DataTypeTok{na.rm =}\NormalTok{ T, }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FloatTok{0.05}\NormalTok{))}
\NormalTok{  scoreDiffBins[}\KeywordTok{length}\NormalTok{(scoreDiffBins)] <-}\StringTok{ }\NormalTok{scoreDiffBins[}\KeywordTok{length}\NormalTok{(scoreDiffBins)] }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{  scoreDiffMat <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{ncol =} \KeywordTok{length}\NormalTok{(scoreDiffBins) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{nrow}\NormalTok{(dataRAPM))}
\NormalTok{  scoreDiffMat2 <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{ncol =} \KeywordTok{length}\NormalTok{(scoreDiffBins) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{nrow}\NormalTok{(dataRAPM))}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{ncol}\NormalTok{(scoreDiffMat))\{}
\NormalTok{    scoreDiffMat[,i] <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(scoreDiff }\OperatorTok{>=}\StringTok{ }\NormalTok{scoreDiffBins[i] }\OperatorTok{&}\StringTok{ }\NormalTok{scoreDiff }\OperatorTok{<}\StringTok{ }\NormalTok{scoreDiffBins[i }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{])}
\NormalTok{    scoreDiffMat2[,i] <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(scoreDiff2 }\OperatorTok{>=}\StringTok{ }\NormalTok{scoreDiffBins[i] }\OperatorTok{&}\StringTok{ }\NormalTok{scoreDiff2 }\OperatorTok{<}\StringTok{ }\NormalTok{scoreDiffBins[i }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{  scoreDiffMatFull <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(scoreDiffMat, scoreDiffMat2)}
  \KeywordTok{colnames}\NormalTok{(scoreDiffMatFull) <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"ScoreDiff_"}\NormalTok{, }\KeywordTok{sapply}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{length}\NormalTok{(scoreDiffBins) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(x) }\KeywordTok{paste0}\NormalTok{(}\KeywordTok{gsub}\NormalTok{(}\StringTok{"%"}\NormalTok{,}\StringTok{""}\NormalTok{,}\KeywordTok{names}\NormalTok{(scoreDiffBins)[x]), }\StringTok{"-"}\NormalTok{, }\KeywordTok{names}\NormalTok{(scoreDiffBins)[x}\OperatorTok{+}\DecValTok{1}\NormalTok{])))}
  
\NormalTok{  ##Time Remaining Features}
\NormalTok{  timeRemaining <-}\StringTok{ }\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_end }\OperatorTok{+}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{game_clock_int_start)}\OperatorTok{/}\DecValTok{2}\OperatorTok{/}\DecValTok{6000} \OperatorTok{+}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(}\DecValTok{4} \OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{period }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{4} \OperatorTok{-}\StringTok{ }\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{period) }\OperatorTok{*}\StringTok{ }\DecValTok{12}
\NormalTok{  timeRemainingFull <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(timeRemaining, }\DecValTok{2}\NormalTok{)}
  
\NormalTok{  ##Absorb Extra Terms into Intercept}
\NormalTok{  homeCourtMatFull <-}\StringTok{ }\NormalTok{homeCourtMatFull[,}\OperatorTok{-}\DecValTok{1}\NormalTok{]}
\NormalTok{  daysRestMatFull <-}\StringTok{ }\NormalTok{daysRestMatFull[, }\OperatorTok{-}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, (}\KeywordTok{ncol}\NormalTok{(daysRestMatFull)}\OperatorTok{/}\DecValTok{2} \OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{))]}
\NormalTok{  scoreDiffMatFull <-}\StringTok{ }\NormalTok{scoreDiffMatFull[,}\OperatorTok{-}\DecValTok{1}\NormalTok{]}
\NormalTok{  scoreTimeInt <-}\StringTok{ }\NormalTok{scoreDiffMatFull }\OperatorTok{*}\StringTok{ }\NormalTok{timeRemainingFull}
\end{Highlighting}
\end{Shaded}

\subsection{Actually Building the Stint Matrix}

For most of the features and effects matrices that were built above, it
is noticeable that most of them required making a duplicate matrix of
sorts and binding the duplicate matrix to the bottom of the original
matrix. As discussed previously, this is becasue we are only looking at
the stint data for the home team and will therefore have to read those
stints for the away team.

In building the stint matrix, as one can see, the first two lines of
code are building matrices of identical size, \(stintMat\) and
\(stintMat2\). The second matrix will reflect the stint data for the
away teams in each game. Within the year for loop, I create another for
loop that cycles through all of the unique players in the stint data and
fills these two stint matrices. As previously described, each of the two
stint matrices indicates an offensive player with a 1 and a defensive
player with a -1. This for loop also updates the minutes played and
possessions played for each player after the garbage time stints have
been removed from the data. This is important because players in the
lowest quartile of possessions played in the stint data are removed from
the analysis and final prediction matrix entirely (meaning that every
stint they are involved in is also removed). This is to make sure that
low possession players are not over inflated by the model (this may
however filter out players who would typically be high possession
players but are injured).

Finally, once the stint matrices are filled and the feature matrices are
binded to the overall stint matrix, the result vector is calculated as
the pts per 100 possessions for each stint.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{  ##Build Stint Matrix}
\NormalTok{  stintMat <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{ncol =} \KeywordTok{nrow}\NormalTok{(player_id_refs) }\OperatorTok{*}\StringTok{ }\DecValTok{2}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{nrow}\NormalTok{(dataRAPM))}
\NormalTok{  stintMat2 <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{ncol =} \KeywordTok{nrow}\NormalTok{(player_id_refs) }\OperatorTok{*}\StringTok{ }\DecValTok{2}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{nrow}\NormalTok{(dataRAPM))}
\NormalTok{  updatedPlayerMinutes <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{person_id =}\NormalTok{ player_id_refs}\OperatorTok{$}\NormalTok{person_id, }\DataTypeTok{full_name =}\NormalTok{ player_id_refs}\OperatorTok{$}\NormalTok{full_name, }\DataTypeTok{mp =} \OtherTok{NA}\NormalTok{, }\DataTypeTok{poss_off =} \OtherTok{NA}\NormalTok{, }\DataTypeTok{poss_def =} \OtherTok{NA}\NormalTok{)}
  \KeywordTok{colnames}\NormalTok{(stintMat) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"Off_"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"ID"}\NormalTok{, player_id_refs}\OperatorTok{$}\NormalTok{person_id)), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"Def_"}\NormalTok{, }\KeywordTok{paste0}\NormalTok{(}\StringTok{"ID"}\NormalTok{, player_id_refs}\OperatorTok{$}\NormalTok{person_id)))}
  \KeywordTok{colnames}\NormalTok{(stintMat2) <-}\StringTok{ }\KeywordTok{colnames}\NormalTok{(stintMat)}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{nrow}\NormalTok{(player_id_refs))\{}
\NormalTok{    stintMat[,i] <-}\StringTok{ }\NormalTok{stintMat[,i] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i]))}
\NormalTok{    stintMat[,i }\OperatorTok{+}\StringTok{ }\KeywordTok{nrow}\NormalTok{(player_id_refs)] <-}\StringTok{ }\NormalTok{stintMat[,i }\OperatorTok{+}\StringTok{ }\KeywordTok{nrow}\NormalTok{(player_id_refs)] }\OperatorTok{-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"opp_team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i]))}
    
\NormalTok{    stintMat2[,i] <-}\StringTok{ }\NormalTok{stintMat2[,i] }\OperatorTok{+}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"opp_team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i]))}
\NormalTok{    stintMat2[,i }\OperatorTok{+}\StringTok{ }\KeywordTok{nrow}\NormalTok{(player_id_refs)] <-}\StringTok{ }\NormalTok{stintMat2[,i }\OperatorTok{+}\StringTok{ }\KeywordTok{nrow}\NormalTok{(player_id_refs)] }\OperatorTok{-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i]))}
    
\NormalTok{    mp_update <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{mp[}\KeywordTok{which}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"opp_team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i])) }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{)])}
\NormalTok{    poss_off_update <-}\StringTok{  }\KeywordTok{sum}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{poss_off[}\KeywordTok{which}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"opp_team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i])) }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{)])}
\NormalTok{    poss_def_update <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{poss_def[}\KeywordTok{which}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(dataRAPM[,}\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"opp_team_player"}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{), }\StringTok{"_person_id"}\NormalTok{))] }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i])) }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{)])}
\NormalTok{    updatedPlayerMinutes}\OperatorTok{$}\NormalTok{mp[}\KeywordTok{which}\NormalTok{(updatedPlayerMinutes}\OperatorTok{$}\NormalTok{person_id }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i])] =}\StringTok{ }\NormalTok{mp_update}
\NormalTok{    updatedPlayerMinutes}\OperatorTok{$}\NormalTok{poss_off[}\KeywordTok{which}\NormalTok{(updatedPlayerMinutes}\OperatorTok{$}\NormalTok{person_id }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i])] =}\StringTok{ }\NormalTok{poss_off_update}
\NormalTok{    updatedPlayerMinutes}\OperatorTok{$}\NormalTok{poss_def[}\KeywordTok{which}\NormalTok{(updatedPlayerMinutes}\OperatorTok{$}\NormalTok{person_id }\OperatorTok{==}\StringTok{ }\NormalTok{player_id_refs}\OperatorTok{$}\NormalTok{person_id[i])] =}\StringTok{ }\NormalTok{poss_def_update}
\NormalTok{  \}}
\NormalTok{  updatedPlayerMinutes}\OperatorTok{$}\NormalTok{poss_tot <-}\StringTok{ }\NormalTok{updatedPlayerMinutes}\OperatorTok{$}\NormalTok{poss_off }\OperatorTok{+}\StringTok{ }\NormalTok{updatedPlayerMinutes}\OperatorTok{$}\NormalTok{poss_def}
\NormalTok{  stintMatFull <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(stintMat, stintMat2)}
\NormalTok{  stintMatFull <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(}\DecValTok{1}\NormalTok{, stintMatFull)}
  \KeywordTok{colnames}\NormalTok{(stintMatFull)[}\DecValTok{1}\NormalTok{] <-}\StringTok{ "Constant"}
\NormalTok{  margin <-}\StringTok{ }\DecValTok{100} \OperatorTok{*}\StringTok{ }\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{pts)}\OperatorTok{/}\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{poss_off}
\NormalTok{  margin2 <-}\StringTok{ }\DecValTok{100} \OperatorTok{*}\StringTok{ }\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{opp_pts)}\OperatorTok{/}\NormalTok{dataRAPM}\OperatorTok{$}\NormalTok{poss_def}
\NormalTok{  marginFull <-}\StringTok{ }\KeywordTok{c}\NormalTok{(margin, margin2)}
\NormalTok{  marginFull[}\KeywordTok{is.na}\NormalTok{(marginFull)] =}\StringTok{ }\DecValTok{0}
\NormalTok{  marginFull[}\KeywordTok{is.infinite}\NormalTok{(marginFull)] =}\StringTok{ }\DecValTok{0}
\NormalTok{  playerTotals <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(playerTotals, person_id }\OperatorTok{%in%}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{gsub}\NormalTok{(}\StringTok{"Def_ID|Off_ID"}\NormalTok{, }\StringTok{""}\NormalTok{,}\KeywordTok{colnames}\NormalTok{(stintMatFull)[}\OperatorTok{-}\DecValTok{1}\NormalTok{])))}
\NormalTok{  playerTotals <-}\StringTok{ }\KeywordTok{arrange}\NormalTok{(playerTotals, person_id)}
\NormalTok{  possVec <-}\StringTok{ }\KeywordTok{c}\NormalTok{(dataRAPM}\OperatorTok{$}\NormalTok{poss_off, dataRAPM}\OperatorTok{$}\NormalTok{poss_def)}
\NormalTok{  stintMatFull <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(stintMatFull, homeCourtMatFull, daysRestMatFull, scoreDiffMatFull, scoreTimeInt)}
  \KeywordTok{rm}\NormalTok{(homeCourtMatFull, homeCourtMat, homeCourtMat2, daysRestMatFull, daysRestMatFull2, scoreDiffMat, scoreDiffMat2, scoreDiffMatFull, scoreTimeInt, stintMat, stintMat2)}
  
\NormalTok{  ##Get Rid of Low Possession Player Stints}
\NormalTok{  possCutoff <-}\StringTok{ }\KeywordTok{summary}\NormalTok{(updatedPlayerMinutes}\OperatorTok{$}\NormalTok{poss_tot)[}\DecValTok{2}\NormalTok{]}
\NormalTok{  LowPossPlayerTotals <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(updatedPlayerMinutes, poss_tot }\OperatorTok{<}\StringTok{ }\NormalTok{possCutoff)}
\NormalTok{  lowPossCols <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"Off_ID"}\NormalTok{, LowPossPlayerTotals}\OperatorTok{$}\NormalTok{person_id), }\KeywordTok{paste0}\NormalTok{(}\StringTok{"Def_ID"}\NormalTok{, LowPossPlayerTotals}\OperatorTok{$}\NormalTok{person_id))}
\NormalTok{  stintMatFull <-}\StringTok{ }\NormalTok{stintMatFull[, }\OperatorTok{-}\KeywordTok{which}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(stintMatFull) }\OperatorTok{%in%}\StringTok{ }\NormalTok{lowPossCols)]}
\NormalTok{  playerIDVars <-}\StringTok{ }\KeywordTok{colnames}\NormalTok{(stintMatFull)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"Def_ID|Off_ID"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(stintMatFull)) }\OperatorTok{==}\StringTok{ }\NormalTok{T)]}
\NormalTok{  stintsToRemove <-}\StringTok{ }\KeywordTok{which}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(}\KeywordTok{abs}\NormalTok{(stintMatFull[,}\KeywordTok{which}\NormalTok{(}\KeywordTok{colnames}\NormalTok{(stintMatFull) }\OperatorTok{%in%}\StringTok{ }\NormalTok{playerIDVars)])) }\OperatorTok{!=}\StringTok{ }\DecValTok{10}\NormalTok{)}
\NormalTok{  stintMatFull <-}\StringTok{ }\NormalTok{stintMatFull[}\OperatorTok{-}\NormalTok{stintsToRemove,]}
\NormalTok{  marginFull <-}\StringTok{ }\NormalTok{marginFull[}\OperatorTok{-}\NormalTok{stintsToRemove]}
\NormalTok{  possFull <-}\StringTok{ }\NormalTok{possVec[}\OperatorTok{-}\NormalTok{stintsToRemove]}
\end{Highlighting}
\end{Shaded}

\section{Ridge Regression Model}

Once the prediction matrix and target vector are created, the next step
is building the ridge regression model. In the code below, I tried two
different models.

The first method I tried was using \(cv.glmnet\) function from the
\(glmnet\) package. This function picks the optimal lambda for you by
iterating through a vector of potential lambdas that I provided in the
\(lambdas\) vector. Typically in ridge regression, most functions
standardize the data. It is important to NOT standardize the data here
because it will dampen the effects of the model. Also, because of the
way that the \(glmnet\) package does its ridge calculations, the actual
resulting coefficients from the model will never be exactly the same as
the manual ridge calculation done below, even if the lambdas are the
same. Similarly, the optimal lambda will typically be as small as
possible (with the current vector of lambdas, the optimal lambda tends
to be 50).

The second model I try is manually calculating ridge regression using
matrix mulitplication. One of the important things to note here is that
\lambda is set to be 2222. This is based on research done by Joe Sill
and Jeremias Engelman on the optimal value for \lambda for RAPM (again,
because cv.glmnet calculates ridge a bit differently, the optimal
\lambda will never be close to 2222 in the first model). Another thing
to note here is the \(W\) matrix, which is a diagonal matrix with the
total number of possessions per stint as the diagonal. One of the
frustrating things about RAPM is that low possession stints are weighted
the same as high possessions, meaning that those stints get
disproportionate weight in player rankings. While RAPM is an efficiency
statistic and values players who produce positively per stint, I find it
important to include a possession-weighting matrix \(W\) into the ridge
regression (in cv.glmnet, I also weighted the ridge regression by number
of possession per stint, a can be seen below). The last step in this
analysis is to report the standard deviations for each RAPM player
coefficient.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{  ##CV Ridge Regression}
\NormalTok{  x <-}\StringTok{ }\NormalTok{stintMatFull}
\NormalTok{  y <-}\StringTok{ }\NormalTok{marginFull}
\NormalTok{  lambdas <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{4000}\NormalTok{, }\DecValTok{50}\NormalTok{)}
\NormalTok{  fit <-}\StringTok{ }\KeywordTok{glmnet}\NormalTok{(x, y, }\DataTypeTok{alpha =} \DecValTok{0}\NormalTok{, }\DataTypeTok{lambda =}\NormalTok{ lambdas, }\DataTypeTok{standardize =}\NormalTok{ F, }\DataTypeTok{standardize.response =}\NormalTok{ F)}
\NormalTok{  cv_fit <-}\StringTok{ }\KeywordTok{cv.glmnet}\NormalTok{(x, y, }\DataTypeTok{alpha =} \DecValTok{0}\NormalTok{, }\DataTypeTok{lambda =}\NormalTok{ lambdas, }\DataTypeTok{weights =}\NormalTok{ possFull, }\DataTypeTok{nfolds =} \DecValTok{10}\NormalTok{, }\DataTypeTok{standardize =}\NormalTok{ F, }\DataTypeTok{standardize.response =}\NormalTok{ F)}
  \CommentTok{# cv_fit <- cv.glmnet(x, y, alpha = 0, lambda = lambdas, standardize = F, standardize.response = F)}
\NormalTok{  opt_lambda <-}\StringTok{ }\NormalTok{cv_fit}\OperatorTok{$}\NormalTok{lambda.min}
  \CommentTok{#opt_lambda <- 50}
\NormalTok{  fit <-}\StringTok{ }\NormalTok{cv_fit}\OperatorTok{$}\NormalTok{glmnet.fit}
  \KeywordTok{summary}\NormalTok{(fit)}
\NormalTok{  allBetas <-}\StringTok{ }\NormalTok{cv_fit}\OperatorTok{$}\NormalTok{glmnet.fit}\OperatorTok{$}\NormalTok{beta[,}\KeywordTok{which}\NormalTok{(cv_fit}\OperatorTok{$}\NormalTok{glmnet.fit}\OperatorTok{$}\NormalTok{lambda }\OperatorTok{==}\StringTok{ }\NormalTok{opt_lambda)]}
\NormalTok{  playerBetas <-}\StringTok{ }\NormalTok{allBetas[}\KeywordTok{names}\NormalTok{(allBetas)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"Off_ID|Def_ID"}\NormalTok{, }\KeywordTok{names}\NormalTok{(allBetas)) }\OperatorTok{==}\StringTok{ }\NormalTok{T)]]}
\NormalTok{  results <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{names}\NormalTok{(playerBetas), }\StringTok{"_ID"}\NormalTok{)))}
  \KeywordTok{names}\NormalTok{(results) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"rapm_type"}\NormalTok{, }\StringTok{"person_id"}\NormalTok{)}
\NormalTok{  results}\OperatorTok{$}\NormalTok{RAPM <-}\StringTok{ }\NormalTok{playerBetas}
\NormalTok{  results <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(results, player_id_refs, }\DataTypeTok{by =} \StringTok{"person_id"}\NormalTok{, }\DataTypeTok{all.x =}\NormalTok{ T)}
\NormalTok{  results <-}\StringTok{ }\KeywordTok{spread}\NormalTok{(results, rapm_type, RAPM)}
  \CommentTok{# results <- subset(results, select = -c(Constant))}
  \KeywordTok{names}\NormalTok{(results)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(results) }\OperatorTok{==}\StringTok{ "Def"}\NormalTok{)] =}\StringTok{ "D_RAPM"}
  \KeywordTok{names}\NormalTok{(results)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(results) }\OperatorTok{==}\StringTok{ "Off"}\NormalTok{)] =}\StringTok{ "O_RAPM"}
\NormalTok{  results}\OperatorTok{$}\NormalTok{RAPM <-}\StringTok{ }\NormalTok{results}\OperatorTok{$}\NormalTok{D_RAPM }\OperatorTok{+}\StringTok{ }\NormalTok{results}\OperatorTok{$}\NormalTok{O_RAPM}
\NormalTok{  results <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(results, updatedPlayerMinutes[,}\KeywordTok{c}\NormalTok{(}\StringTok{"person_id"}\NormalTok{, }\StringTok{"mp"}\NormalTok{)], }\DataTypeTok{by =} \StringTok{"person_id"}\NormalTok{, }\DataTypeTok{all.x =}\NormalTok{ T)}
\NormalTok{  results <-}\StringTok{ }\KeywordTok{arrange}\NormalTok{(results, }\OperatorTok{-}\NormalTok{RAPM)}
  
\NormalTok{  ##Bayesian Ridge Calculation}
\NormalTok{  lambda <-}\StringTok{ }\DecValTok{2222}
  \CommentTok{# lambda <- 4500}
  \CommentTok{# lambda <- 1500}
\NormalTok{  W <-}\StringTok{ }\KeywordTok{Matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DataTypeTok{nrow =} \KeywordTok{nrow}\NormalTok{(x), }\DataTypeTok{ncol =} \KeywordTok{nrow}\NormalTok{(x))}
  \KeywordTok{diag}\NormalTok{(W) <-}\StringTok{ }\NormalTok{possFull}
\NormalTok{  xTx <-}\StringTok{ }\KeywordTok{t}\NormalTok{(x) }\OperatorTok{%*%}\StringTok{ }\NormalTok{W }\OperatorTok{%*%}\StringTok{ }\NormalTok{x}
\NormalTok{  xTy <-}\StringTok{ }\KeywordTok{t}\NormalTok{(x) }\OperatorTok{%*%}\StringTok{ }\NormalTok{W }\OperatorTok{%*%}\StringTok{ }\NormalTok{y}
\NormalTok{  xTx <-}\StringTok{ }\KeywordTok{t}\NormalTok{(x) }\OperatorTok{%*%}\StringTok{ }\NormalTok{x}
\NormalTok{  xTy <-}\StringTok{ }\KeywordTok{t}\NormalTok{(x) }\OperatorTok{%*%}\StringTok{ }\NormalTok{y}
\NormalTok{  I <-}\StringTok{ }\KeywordTok{diag}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(xTy))}
\NormalTok{  xTx_lambda <-}\StringTok{ }\NormalTok{xTx }\OperatorTok{+}\StringTok{ }\NormalTok{lambda }\OperatorTok{*}\StringTok{ }\NormalTok{I}
\NormalTok{  mean <-}\StringTok{ }\KeywordTok{solve}\NormalTok{(xTx_lambda) }\OperatorTok{%*%}\StringTok{ }\NormalTok{xTy}
\NormalTok{  playerMeanBetas <-}\StringTok{ }\NormalTok{mean[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"Off_ID|Def_ID"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(x)) }\OperatorTok{==}\StringTok{ }\NormalTok{T)]}
\NormalTok{  meanDF <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{varID =} \KeywordTok{colnames}\NormalTok{(x)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{grepl}\NormalTok{(}\StringTok{"Off_ID|Def_ID"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(x)) }\OperatorTok{==}\StringTok{ }\NormalTok{T)], }\DataTypeTok{RAPM =}\NormalTok{ playerMeanBetas)}
  \KeywordTok{row.names}\NormalTok{(meanDF) <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  meanDF}\OperatorTok{$}\NormalTok{varID <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(meanDF}\OperatorTok{$}\NormalTok{varID)}
\NormalTok{  meanDF <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{rapm_type =} \KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{strsplit}\NormalTok{(meanDF}\OperatorTok{$}\NormalTok{varID, }\StringTok{"_ID"}\NormalTok{))[,}\DecValTok{1}\NormalTok{],}
                       \DataTypeTok{person_id =} \KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{strsplit}\NormalTok{(meanDF}\OperatorTok{$}\NormalTok{varID, }\StringTok{"_ID"}\NormalTok{))[,}\DecValTok{2}\NormalTok{]),}
                       \DataTypeTok{RAPM =}\NormalTok{ meanDF}\OperatorTok{$}\NormalTok{RAPM)}
\NormalTok{  meanDF <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(meanDF, player_id_refs, }\DataTypeTok{by =} \StringTok{"person_id"}\NormalTok{, }\DataTypeTok{all.x =}\NormalTok{ T)}
\NormalTok{  meanDF <-}\StringTok{ }\KeywordTok{spread}\NormalTok{(meanDF, rapm_type, RAPM)}
  \KeywordTok{names}\NormalTok{(meanDF)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(meanDF) }\OperatorTok{==}\StringTok{ "Def"}\NormalTok{)] =}\StringTok{ "D_RAPM"}
  \KeywordTok{names}\NormalTok{(meanDF)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(meanDF) }\OperatorTok{==}\StringTok{ "Off"}\NormalTok{)] =}\StringTok{ "O_RAPM"}
\NormalTok{  meanDF <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(meanDF, updatedPlayerMinutes[,}\KeywordTok{c}\NormalTok{(}\StringTok{"person_id"}\NormalTok{, }\StringTok{"mp"}\NormalTok{, }\StringTok{"poss_off"}\NormalTok{, }\StringTok{"poss_def"}\NormalTok{, }\StringTok{"poss_tot"}\NormalTok{)], }\DataTypeTok{by =} \StringTok{"person_id"}\NormalTok{, }\DataTypeTok{all.x =}\NormalTok{ T)}
\NormalTok{  meanDF}\OperatorTok{$}\NormalTok{RAPM <-}\StringTok{ }\NormalTok{meanDF}\OperatorTok{$}\NormalTok{O_RAPM }\OperatorTok{+}\StringTok{ }\NormalTok{meanDF}\OperatorTok{$}\NormalTok{D_RAPM}
\NormalTok{  meanDF <-}\StringTok{ }\KeywordTok{arrange}\NormalTok{(meanDF, }\OperatorTok{-}\NormalTok{RAPM)}
  
\NormalTok{  sigma <-}\StringTok{ }\DecValTok{3}
\NormalTok{  var <-}\StringTok{ }\NormalTok{lambda }\OperatorTok{*}\StringTok{ }\NormalTok{sigma }\OperatorTok{*}\StringTok{ }\KeywordTok{solve}\NormalTok{(xTx_lambda)}
\NormalTok{  varDF <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{rapm_type =} \KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{names}\NormalTok{(}\KeywordTok{diag}\NormalTok{(var)), }\StringTok{"_ID"}\NormalTok{))[,}\DecValTok{1}\NormalTok{],}
                      \DataTypeTok{person_id =} \KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{strsplit}\NormalTok{(}\KeywordTok{names}\NormalTok{(}\KeywordTok{diag}\NormalTok{(var)), }\StringTok{"_ID"}\NormalTok{))[,}\DecValTok{2}\NormalTok{]),}
                      \DataTypeTok{VAR =} \KeywordTok{diag}\NormalTok{(var))}
  \KeywordTok{row.names}\NormalTok{(varDF) <-}\StringTok{ }\OtherTok{NULL}
\NormalTok{  varDF <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(varDF, rapm_type }\OperatorTok{!=}\StringTok{ "Constant"}\NormalTok{)}
\NormalTok{  varDF <-}\StringTok{ }\KeywordTok{spread}\NormalTok{(varDF, rapm_type, VAR)}
  \KeywordTok{names}\NormalTok{(varDF)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(varDF) }\OperatorTok{==}\StringTok{ "Def"}\NormalTok{)] =}\StringTok{ "D_Var"}
  \KeywordTok{names}\NormalTok{(varDF)[}\KeywordTok{which}\NormalTok{(}\KeywordTok{names}\NormalTok{(varDF) }\OperatorTok{==}\StringTok{ "Off"}\NormalTok{)] =}\StringTok{ "O_Var"}
\NormalTok{  RAPM_DF <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(meanDF, varDF, }\DataTypeTok{by =} \StringTok{"person_id"}\NormalTok{, }\DataTypeTok{all.x =}\NormalTok{ T)}
\NormalTok{  RAPM_DF <-}\StringTok{ }\KeywordTok{arrange}\NormalTok{(RAPM_DF, }\OperatorTok{-}\NormalTok{RAPM)}
\NormalTok{  RAPM_DF}\OperatorTok{$}\NormalTok{season_name <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(}\StringTok{"NBA_"}\NormalTok{, ssn), }\KeywordTok{nrow}\NormalTok{(RAPM_DF))}
\NormalTok{  RAPM_list[[ssn]] <-}\StringTok{ }\NormalTok{RAPM_DF}
\ErrorTok{\}}
\NormalTok{RAPM_full <-}\StringTok{ }\KeywordTok{do.call}\NormalTok{(rbind, RAPM_list)}
\end{Highlighting}
\end{Shaded}

\section{Possible Improvements}

The biggest improvement to be made is to implement a model that adds an
informative Bayesian prior with the previous year's O-RAPM and D-RAPM
for each player. While RAPM is a very valuable statistic and can be very
positive when given enough stints to learn over time, some players in
certain years can get very undervalued due to certain inconsistencies
during the year. For instance, in 2018-19 Rudy Gobert's plus-minus
production dipped relative to his defensive dominance in previous years.
Instead of being a top D-RAPM candidate like he usually is, he was not
very close to the top in production and rating. One way to correct for
that is to run a 3-year RAPM model to regularize the results a bit.
Another answer could be to use his 2017-18 O-RAPM and D-RAPM results as
priors.

Another important thing to fix is how variance and standard deviation
results are calculated in the manual ridge regression. I had trouble
calculating what sigma actually should be to yield the correct standard
deviation results. Some more thought and work should be put into this.


\end{document}
